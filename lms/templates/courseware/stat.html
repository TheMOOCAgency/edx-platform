<%page expression_filter="h"/>
<%inherit file="/main.html" />
<%namespace name='static' file='/static_content.html'/>
<%def name="online_help_token()"><% return "courseware" %></%def>
<%!
from django.utils.translation import ugettext as _
from django.conf import settings

from edxnotes.helpers import is_feature_enabled as is_edxnotes_enabled
from openedx.core.djangolib.markup import HTML
from openedx.core.djangolib.js_utils import js_escaped_string
from datetime import datetime, date
from student.models import User
from courseware.views.index import CoursewareIndex
#GEOFFREY

from opaque_keys.edx.keys import CourseKey
from lms.djangoapps.course_blocks.api import get_course_blocks_tma
from openedx.core.djangoapps.bookmarks.api import get_bookmark,get_bookmarks
from opaque_keys.edx.locations import SlashSeparatedCourseKey
from xmodule.modulestore.django import modulestore

%>
<%block name="pagetitle">${_("Dashboard")}</%block>
<!--
<script src="${static.url('js/stat_dashboard.js')}"></script>
-->
<!-- css assets -->
<%
stat_dashboard = static.get_value('css_overrides_stat_dashboard')
logo_url = static.get_value('logo')
if logo_url is None:
  logo_url = '/static/images/logo.png'

target = course_id.split('+')
%>
% if not stat_dashboard:
  <link rel="stylesheet" type="text/css" href="${static.url('css/stat_dashboard.css')}">
% else:
  <link rel="stylesheet" type="text/css" href="${static.url(stat_dashboard)}" />
% endif

<style>
#participant_search {
  background-image: url("${static.url('images/search.png')}");
  background-position: center;
  background-repeat: no-repeat;
}
#loader {
  background-image: url("${static.url('images/loading.gif')}");
  background-position: center;
  background-repeat: no-repeat;
  background-size: cover;
}
#voile {
 position: fixed !important;
}
#title {
  font-size: 15px !important;
}
#fil_ariane a,#fil_ariane a:hover,#fil_ariane a:focus,#fil_ariane a:visited {
    color: #31aeee;
    text-shadow: none;
    text-decoration: none;
}
#header {
  background-color: transparent;
  text-align: left;
  padding: 20px;
  padding-left: 50px;
  padding-right: 50px;
  width: calc(100% - 100px);
}
#title h1 {
  font-size: 23px !important;
  line-height: 23px;
  text-transform: uppercase;
  color: #05144d;
  font-weight: bold;
  font-family: "mywebfont";
  text-align: left;
}
#cartouche {
  width: calc(100% - 2px);
  border: 1px solid #b2b2b2;
  height: auto;
  min-height: 151.5px;
}
#course_img {
  width: 224px;
  height:151px;
  border-right: 1px solid #b2b2b2;
  position: relative;
}
#course_img img {
  width: 100%;
  height: 100%;
}
#categorie_info {
  position: absolute;
  height: 25px;
  line-height: 25px;
  vertical-align: middle;
  text-align: center;
  bottom: 0;
  left: 0;
  z-index: 2;
  color: #fff;
}
#cartouche {
  width: calc(100% - 2px);
  border: 1px solid #b2b2b2;
  height: auto;
  min-height: 151.5px;
  background-color: #fff;
}
#course_img {
  width: 224px;
  height:151px;
  border-right: 1px solid #b2b2b2;
  position: relative;
}
#course_img img {
  width: 100%;
  height: 100%;
}
#categorie_info {
  position: absolute;
  height: 25px;
  line-height: 25px;
  vertical-align: middle;
  text-align: center;
  bottom: 0;
  left: 0;
  z-index: 2;
  color: #fff;
}
.svg-class {
  height: 20px;
  width: 20px;
  margin-top: 10px;
  margin-bottom: 10px;
  display: block;
  float: left;
  margin-left: 5px;
}
.svg-class path {
  fill: #dc9e29;
  color: #dc9e29;
}
#course_img,#cartouche_info{
  float: left;
}
#cartouche_info {
  height: auto;
  min-height: 151.5px;
  position: relative;
  width: auto;
}
#cartouche_info h3 {
  font-weight: bold;
  padding: 10px;
  text-transform:uppercase;
  /* primary color */
  color: #05144d;
  font-size: 30px;
}
#header p {
  font-size: 15px;
  /* primary color */
  color: #05144d;
  padding-left: 10px;
  width: calc(100% - 10px);
}
#cartouche_info p {
  padding-top: 3px;
  padding-bottom: 3px;
}
#cartouche_info p span {
  font-weight: bold;
}
.duration_course {
  position :absolute;
  left: 10px;
  bottom: 10px;
  line-height: 40px;
  vertical-align: middle;
}
.duration_course span {
  margin-left: 5px;
  color: #cf9c49;
}
#title {
  height: auto;
}
#Calque_1 {
  fill: red;
}
</style>
<div id="contenair">
  <!-- header -->
  <div id="header">
    <div id="fil_ariane"><a href="/">${_('My campaigns')} ></a></div>
    <div id="title">
      <h1>${_('Statistical training campaign')}</h1>
    </div>
    <div id="cartouche">
      <div id="course_img">
        <img src="${overview.image_urls['small']}" />
        <div id="categorie_info">
        </div>
      </div>
      <div id="cartouche_info">
        <h3>${course.display_name_with_default_escaped}</h3>
        <p><span>${_("Results on ")}</span>
          % if course.end:
            ${course.end.strftime('%d-%m-%Y')}
          % endif
        </p>
        <div class="duration_course">
          <object oa-reusable-svg
          data="${static.url('images/duree.svg')}"
          type="image/svg+xml"
          class="svg-class"
          data-class="timer_svg_color"
          >
          </object>
          <span>${overview.effort}</span>
        </div>
      </div>
    <span style="display:block;clear:left;"></span>
    </div>
  </div>
  <!-- a rajouter -->



  <!-- a rajouter -->
  <!-- dashboard -->
  <section class="section_block">
    <div id="dashboard">
      <div id="table_info" class="dashboard">
        <h2>${_('training campaign info')}</h2>
      <!--
        <p>${_('launching date')} : <span></span></p>
      -->
        <p><button id="generate_xls">${_("Download participants' list")}</button></p>
        <p>${_("editor")} : <span>${course.editor}</span>
        <p>${_('starting date')} : <span>${course.start.strftime('%d-%m-%Y')}</span></p>
        <p>${_('ending date')} : <span>
% if course.end:
  ${course.end.strftime('%d-%m-%Y')}
% endif
      </span></p>
      <p>${_("number of questions")} : <span id="question_num"></span>
      <p>${_('percentage for success')} : <span>${course_module.grade_cutoffs['Pass'] * 100} %</span></p>
      <p>${_('Mode')} : <span>
% if course.is_required_atp:
  ${_('mandatory')}
% else:
  ${_('optional')}
% endif
      </span></p>
      <p>${_('Status')} : <span>
% if course.end:
  % if course.end.date() > datetime.today().date():
    ${_('In progress')}
  % else:
    ${_('End')}
  % endif
% else:
  ${_('In progress')}
% endif
        </span></p>
      </div>
      <div id="table_stat" class="dashboard">
        <h2>${_('users stats')}</h2>
        <div id="cellule_stat">
          <div class="cellule_stat" id="cellule_stat_first">
            <p>${_('Network')}</p>
            <img src="${logo_url}" />
          </div>
          <div class="cellule_stat">
            <p>${_('Target')}</p>
            <p id="title">${target[1]}<br>${target[2]}</p>
          </div>
          <div class="cellule_stat">
            <p>${_('Guests')}</p>
            <p>${all_user}</p>
          </div>
          <div class="cellule_stat" id="cellule_stat_last">
            <p>${_('Participants')}</p>
            <p>${user_course_started}</p>
          </div>
          <div style="clear:left;"></div>
        </div>
        <div id="result">
          <h2>${_('Results')}</h2>
          <div id="cell_result">
            <div class="cell_result" id="cell_result_first">
              <p>${_('Certified')}</p>
              <p id="num_result_on">${num_passed}</p>
            </div>
            <div class="cell_result" id="cell_result_last">
              <p>${_('Average result')}</p>
              <p>${course_average_grade} %</p>
            </div>
            <div style="clear:left;"></div>
          </div>
        </div>
      </div>
      <div style="clear:left;"></div>
    </section>
    <section class="section_block">
      <div id="score_title">
        <h2>${_('Average score')}</h2>
      </div>
      <div id="block_stat_question">
      <div id="voile"><div id="loader"></div></div>
        <div id="nav_block_stat_question">
          <button data-position="average">${_('per question')}</button>
          <button data-position="participant">${_('per participant')}</button>
          <span style="display:block;clear:left;"></span>
        </div>
        <div id="body_block_stat_question">
          <div id="block_average" class="block_question">
% for chapter in course_structure:
  % if 'problem' in str(chapter):
  <div class="chapter_box">
    <h3 data-id="${chapter['id']}">${chapter['display_name']}</h3>
    % for section in chapter['children']:
      % if 'problem' in str(section):
      <div class="section_box">
        <h4 data-id="${section['id']}">${section['display_name']}</h4>
        % for vertical in section['children']:
          % if 'problem' in str(vertical):
          <span data-children="${vertical['children']}" data-title="${vertical['display_name']}" class="data_content"></span>
          % endif
        % endfor
        <div class="problem_box"></div>
      </div>
      % endif
    % endfor
  </div>
  % else:
  <div class="chapter_box">
    <h3 data-id="${chapter['id']}">${chapter['display_name']}</h3>
    % for section in chapter['children']:
        <div class="section_box">
          <h4 data-id="${section['id']}">${section['display_name']}</h4>
            <div class="problem_box">
              <ul>
        % for vertical in section['children']:
                <li><span class="puce_li"></span><p>${vertical['display_name']} <span class="unrated_unit_span">(${_('unrated unit')})</span></p></li>
        % endfor
              </ul>
            </div>
        </div>
    % endfor
  </div>
  % endif
% endfor
          </div>
          <!-- block participant -->
          <!-- block participant -->
          <!-- block participant -->
          <div id="block_participant" class="block_question">
            <!-- nav paricipant -->
            <!-- nav paricipant -->
            <!-- nav paricipant -->
            <div id="nav_participant">
              <!-- search block -->
              <!-- search block -->
              <!-- search block -->
              <div id="form_participant">
                <input type="text" name="name_participant" id="name_participant" value="" />
                <button id="participant_search" data-courseid="${course_id}"></button>
                <div style="clear:left;"></div>
                <div id="list_participant"></div>
              </div>
              <button id="generate_grades">${_("Download users grade")}</button>
              <div id="table_participant">
              </div>
            </div>
            <div id="content_participant">
<span id="inside_user_content">
<%
num_question = 0
%>
% for chapter in course_structure:
  % if 'problem' in str(chapter):
  <div class="chapter_box">
    <h3 data-id="${chapter['id']}">${chapter['display_name']}</h3>
    % for section in chapter['children']:
      % if 'problem' in str(section):
      <div class="section_box">
        <h4 data-id="${section['id']}">${section['display_name']}</h4>
        % for vertical in section['children']:
          % if 'problem' in str(vertical):
          <span data-children="${vertical['children']}" data-title="${vertical['display_name']}" class="data_content"></span>
          <%
          for n in vertical['children']:
            if 'problem' in n:
              num_question = num_question + 1
          %>
          % endif
        % endfor
        <div class="problem_box"></div>
      </div>
      % endif
    % endfor
  </div>
  % else:
  <div class="chapter_box">
    <h3 data-id="${chapter['id']}">${chapter['display_name']}</h3>
    % for section in chapter['children']:
        <div class="section_box">
          <h4 data-id="${section['id']}">${section['display_name']}</h4>
            <div class="problem_box">
              <ul>
        % for vertical in section['children']:
                <li><span class="puce_li"></span><p>${vertical['display_name']} <span class="unrated_unit_span">(${_('unrated unit')})</span></p></li>
        % endfor
              </ul>
            </div>
        </div>
    % endfor
  </div>
  % endif
% endfor
</span>
            </div>
          </div>
        </div>
    </section>
  </div>
</div>
<%
course_key = CourseKey.from_string(course_id)
course_usage_key = modulestore().make_course_usage_key(course_key)
%>
<script>
// test
var course_key = "${course_usage_key}";
// final
var grade_img_success = "${static.url('images/user_grade_success.png')}";
var grade_img_fail = "${static.url('images/user_grade_fail.png')}";
// translate
var stat_email = '${_("Email")}';
var stat_grade = '${_("Grade")}';
var stat_first = '${_("First name")}';
var stat_last = '${_("Last name")}';
console.log(stat_email+' '+stat_grade+' '+stat_first+' '+stat_last);
</script>
<script src="${static.url('js/stat_dashboard.js')}"></script>
<!-- action sur le dom -->
<script>
function info_p() {
  var p = 0;
  $('#table_info').find('p').attr('style','');
  var width = $(document).width();
  if(width < 729){
    $('#table_info').find('p').each(function(){
      var This = $(this);
      var c = This.height();
      if(c > p) {
        p = c;
      }
    })
    $('#table_info').find('p').css('height',p+'px');
  }else{
    $('#table_info').find('p').attr('style','');
  }
}
function heightCelluleStat() {
  $('.cellule_stat').each(function(){
    var This = $(this);
    var width = This.width();
    This.css('height',width+'px');
    var heightP = This.find('p:first-child').height();
    var paddingP = 50;
    var heightS = heightP + 50;
  })
}
</script>
<!-- action on dom -->
<script>
$(document).ready(function(){
  heightCelluleStat();
  info_p();
  $('#question_num').text("${num_question}");
  setInterval(function(){
    $('.svg-class').each(function(){
      $(this).contents().find('svg').attr('fill','#cf9c49');
    })
  },500);

})
$(window).resize(function(){
  heightCelluleStat();
  alignCells();
  info_p();
})
$('#generate_xls').click(function(){
  var current_path = window.location.pathname;
  var url = current_path+'/generate_xls/'
  $.ajax({
    type:'get',
    url:url,
    dataType:'json',
    success:function(data) {
      var filename = data.filename;
      var xls_url = '/atp/download_xls/'+filename;
      window.open(xls_url,'_self');
    }
  })

})
$('#generate_grades').click(function(){
  var current_path = window.location.pathname;
  var url = current_path+'/generate_grades/'
  $.ajax({
    type:'get',
    url:url,
    dataType:'json',
    success:function(data) {
      var filename = data.filename;
      var xls_url = '/atp/download_grades/'+filename;
      window.open(xls_url,'_self');
    }
  })

})
</script>
<style>
#nav_participant {
  position: relative;
}
#generate_grades,#generate_grades:hover,#generate_grades:focus,#generate_grades:visited {
  border:none;
  /* primary color */
  box-shadow: none;
  border-radius: 0;
  text-shadow: none;
  color: #31aeee;
  position: absolute;
  top: 55px;
  text-decoration: underline;
  right: 20px;
  text-transform: lowercase;
}
@media(max-width:834px) {
  #generate_grades,#generate_grades:hover,#generate_grades:focus,#generate_grades:visited {
    top: 5px;
    right: 0;
    left: 25px;
  }
}
#generate_xls,#generate_xls:hover,#generate_xls:focus,#generate_xls:visited {
  color: #fff;
  border: none;
  background-color: #cf9c49;
  border-radius: 0;
  text-shadow: none;
  font-size: 18px;
}
</style>
